<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/html">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
</head>
<body>


<!-- Display recognized text -->


<div class="container text-center vh100">
    <div class="row align-items-center">
        <div class="col">
            <form action="{% url 'previous-word' %}">
                {% csrf_token %}
                <button type="submit">Предишна дума</button>
            </form>
        </div>
        <div class="col">
            <div class="container text-center">
                <div class="row align-items-center">
                    <div class="col">
                        <a href="{% url 'teacher-reader' %}"><h1>Hello</h1></a>
                        <p><strong id="currentWord">{{ word }}</strong></p>
                        <p id="recognized-text"></p>
                    </div>
                    <div class="col">
                        <button id="speech-btn" onclick="toggleRecognition()">Започни да четеш</button>
                    </div>
                    <div class="col">
                        <button id="reading-btn" onclick="readWord()">Прочети вместо мен</button>
                        <audio id="audio-player" controls style="display: none;"></audio>
                    </div>
                </div>
            </div>


        </div>
        <div class="col">
            <form action="{% url 'next-word' %}">
                {% csrf_token %}
                <button type="submit">Следваща дума</button>
            </form>
        </div>
    </div>
</div>


<script>
    let recognition;
    let recognizing = false;

    if (!('webkitSpeechRecognition' in window)) {
        alert("Your browser doesn't support the Web Speech API. Please try this in Chrome.");
    } else {
        recognition = new webkitSpeechRecognition();
        recognition.continuous = true;  // Keep recognizing speech until stopped
        recognition.interimResults = true;  // Show interim results while the user is speaking
        recognition.lang = 'bg-BG';  // Set the language

        recognition.onstart = function () {
            recognizing = true;
            document.getElementById('speech-btn').innerText = "Спри да четеш";
        };

        recognition.onend = function () {
            recognizing = false;
            document.getElementById('speech-btn').innerText = "Започни да четеш";

            if (document.getElementById('currentWord').innerText.toLowerCase() === document.getElementById('recognized-text').innerText) {
                alert('Добра работа!');
            }
        };

        recognition.onresult = function (event) {
            let interimTranscript = '';
            let finalTranscript = '';

            for (let i = 0; i < event.results.length; i++) {
                const transcript = event.results[i][0].transcript;
                if (event.results[i].isFinal) {
                    finalTranscript += transcript + ' ';
                } else {
                    interimTranscript += transcript;
                }
            }

            document.getElementById('recognized-text').innerText = finalTranscript || interimTranscript;
        };


        recognition.onerror = function (event) {
            console.error('Speech recognition error detected: ', event.error);
            alert('Error occurred in speech recognition: ' + event.error);
        };
    }

    function toggleRecognition() {
        if (recognizing) {
            recognition.stop();
            return;
        }
        recognition.start();
    }

    function readWord() {
        const wordToRead = document.getElementById('currentWord').innerText

        fetch(`{% url 'read-word' %}?text=${encodeURIComponent(wordToRead)}`)
            .then(response => response.blob())
            .then(blob => {
                const audioUrl = URL.createObjectURL(blob);
                const audioPlayer = document.getElementById('audio-player');
                audioPlayer.src = audioUrl;
                audioPlayer.style.display = 'none';
                audioPlayer.play();
            })
            .catch(error => console.error('Error:', error));
    }

</script>
</body>
</html>